name: Build iOS18SiriRipple.deb

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-deb:
    runs-on: macos-latest
    timeout-minutes: 20
    env:
      PROJECT_NAME: iOS18SiriRipple
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout code
      uses: actions/checkout@v4
      
    # 2. ç¡®è®¤é¡¹ç›®ç»“æž„
    - name: Verify project structure
      run: |
        echo "ðŸ“‚ é¡¹ç›®ç»“æž„:"
        ls -la
        echo ""
        echo "ðŸ“¦ ${{ env.PROJECT_NAME }} ç›®å½•å†…å®¹:"
        ls -la ${{ env.PROJECT_NAME }}/
      
    # 3. è®¾ç½®XcodeçŽ¯å¢ƒ  
    - name: Setup Xcode
      run: |
        sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
        echo "Xcodeç‰ˆæœ¬: $(xcodebuild -version)"
        echo "å·¥ä½œç›®å½•: $(pwd)"
      
    # 4. å®‰è£…å¿…è¦å·¥å…·
    - name: Install build tools
      run: |
        brew update
        brew install dpkg
        brew install ldid
        brew install wget
      
    # 5. ç¼–è¯‘é¡¹ç›®ï¼ˆä½¿ç”¨æ­£ç¡®çš„é¡¹ç›®è·¯å¾„ï¼‰
    - name: Build project
      run: |
        # è¿›å…¥é¡¹ç›®ç›®å½•
        cd ${{ env.PROJECT_NAME }}
        
        echo "ðŸ› ï¸ å¼€å§‹æž„å»ºé¡¹ç›®..."
        xcodebuild -project ${{ env.PROJECT_NAME }}.xcodeproj \
                   -scheme ${{ env.PROJECT_NAME }} \
                   -configuration Release \
                   -sdk iphoneos \
                   -derivedDataPath ../build_output \
                   CODE_SIGN_IDENTITY="" \
                   CODE_SIGNING_REQUIRED=NO \
                   CODE_SIGNING_ALLOWED=NO
        
        echo "âœ… é¡¹ç›®ç¼–è¯‘å®Œæˆ"
      
    # 6. åˆ›å»ºDEBåŒ…
    - name: Create deb package
      run: |
        # è®¾ç½®ç¼–è¯‘äº§ç‰©è·¯å¾„
        BINARY_PATH="build_output/Build/Products/Release-iphoneos/${{ env.PROJECT_NAME }}.framework/${{ env.PROJECT_NAME }}"
        
        # éªŒè¯ç¼–è¯‘äº§ç‰©å­˜åœ¨
        if [ ! -f "$BINARY_PATH" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°ç¼–è¯‘äº§ç‰©"
          echo "ç¼–è¯‘è¾“å‡ºç›®å½•å†…å®¹:"
          ls -lR build_output
          exit 1
        fi
        
        # åˆ›å»ºDEBåŒ…ç»“æž„
        mkdir -p package/Library/MobileSubstrate/DynamicLibraries
        mkdir -p package/DEBIAN
        
        # å¤åˆ¶ç¼–è¯‘äº§ç‰©
        cp "$BINARY_PATH" package/Library/MobileSubstrate/DynamicLibraries/${{ env.PROJECT_NAME }}.dylib
        echo "âœ… å·²å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶"
        
        # åˆ›å»ºplisté…ç½®æ–‡ä»¶
        cat > package/Library/MobileSubstrate/DynamicLibraries/${{ env.PROJECT_NAME }}.plist <<EOF
        { 
            Filter = { 
                Bundles = ( "com.apple.springboard" ); 
            }; 
        }
        EOF
        echo "âœ… å·²åˆ›å»ºplistæ–‡ä»¶"
        
        # åˆ›å»ºcontrolæŽ§åˆ¶æ–‡ä»¶
        cat > package/DEBIAN/control <<EOF
        Package: com.behuge.${{ env.PROJECT_NAME }}
        Name: ${{ env.PROJECT_NAME }}
        Version: 1.0.0
        Architecture: iphoneos-arm
        Description: iOS 18 style Siri ripple animation
        Maintainer: 873116202
        Author: 873116202
        Section: Tweaks
        Depends: mobilesubstrate
        EOF
        echo "âœ… å·²åˆ›å»ºcontrolæ–‡ä»¶"
        
        # åˆ›å»ºå®‰è£…åŽè„šæœ¬
        cat > package/DEBIAN/postinst <<EOF
        #!/bin/bash
        # è®¾ç½®æ–‡ä»¶æƒé™
        chmod 0755 /Library/MobileSubstrate/DynamicLibraries/${{ env.PROJECT_NAME }}.dylib
        chmod 0644 /Library/MobileSubstrate/DynamicLibraries/${{ env.PROJECT_NAME }}.plist
        
        # é‡å¯SpringBoard
        killall -9 SpringBoard
        echo "âœ… SpringBoardå·²é‡å¯ï¼Œè¯·è§£é”è®¾å¤‡æŸ¥çœ‹æ•ˆæžœ"
        EOF
        chmod 0755 package/DEBIAN/postinst
        echo "âœ… å·²åˆ›å»ºpostinstè„šæœ¬"
        
        # æ‰“åŒ…ä¸ºDEBæ–‡ä»¶
        dpkg-deb -b package ../${{ env.PROJECT_NAME }}.deb
        echo "ðŸŽ‰ DEBåŒ…åˆ›å»ºæˆåŠŸï¼š${{ env.PROJECT_NAME }}.deb"
      
    # 7. ä¸Šä¼ åˆ¶å“
    - name: Upload DEB artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}.deb
        path: ${{ env.PROJECT_NAME }}.deb
      
    # 8. åˆ›å»ºå‘å¸ƒï¼ˆå¯é€‰ï¼‰
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ env.PROJECT_NAME }}.deb
        tag_name: ${{ github.ref }}
        body: "iOS18SiriRipple deb package"
