name: Build iOS18SiriRipple.deb

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-deb:
    runs-on: macos-latest
    timeout-minutes: 30
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout code
      uses: actions/checkout@v4
      
    # 2. çŽ¯å¢ƒè¯Šæ–­
    - name: Diagnostic information
      run: |
        echo "##[group]ðŸ› ï¸ çŽ¯å¢ƒè¯Šæ–­"
        echo "å·¥ä½œç›®å½•: $(pwd)"
        echo "Xcodeç‰ˆæœ¬: $(xcodebuild -version)"
        echo "å¯ç”¨SDK:"
        xcodebuild -showsdks
        echo "é¡¹ç›®ç»“æž„:"
        ls -la iOS18SiriRipple
        echo "##[endgroup]"
      
    # 3. å®‰è£…å¿…è¦å·¥å…·
    - name: Install build tools
      run: |
        brew update
        brew install dpkg ldid wget
        
    # 4. è®¾ç½®å¼€å‘çŽ¯å¢ƒ
    - name: Setup environment
      run: |
        # è®¾ç½®Xcodeè·¯å¾„
        sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
        
        # åˆ›å»ºç¼“å­˜æ¸…ç†è„šæœ¬
        cat > clean_cache.sh <<EOF
        #!/bin/bash
        rm -rf build_output
        rm -rf ~/Library/Developer/Xcode/DerivedData/*
        rm -rf ~/Library/Caches/com.apple.dt.Xcode/*
        EOF
        chmod +x clean_cache.sh
        
    # 5. ä¿®å¤é¡¹ç›®é…ç½®
    - name: Fix project configuration
      run: |
        cd iOS18SiriRipple
        
        # å¤‡ä»½åŽŸå§‹é¡¹ç›®æ–‡ä»¶
        cp iOS18SiriRipple.xcodeproj/project.pbxproj project.pbxproj.bak
        
        # ç¡®ä¿Metalæ–‡ä»¶åŒ…å«åœ¨æž„å»ºä¸­
        if ! grep -q "Shader.metal" iOS18SiriRipple.xcodeproj/project.pbxproj; then
          echo "æ·»åŠ Metalæ–‡ä»¶åˆ°ç¼–è¯‘æº..."
          /usr/libexec/PlistBuddy -c "Add :objects:8F6D2D352A3F4A9C001A7C1F:files:0 string Shader.metal" iOS18SiriRipple.xcodeproj/project.pbxproj
        fi
        
        # ç¡®ä¿æž¶æž„è®¾ç½®ä¸ºarm64
        if ! grep -q "ARCHS = arm64" iOS18SiriRipple.xcodeproj/project.pbxproj; then
          echo "è®¾ç½®ARCHSä¸ºarm64..."
          /usr/libexec/PlistBuddy -c "Set :objects:8F6D2D352A3F4A9C001A7C1F:buildSettings:ARCHS arm64" iOS18SiriRipple.xcodeproj/project.pbxproj
          /usr/libexec/PlistBuddy -c "Set :objects:8F6D2D352A3F4A9C001A7C1F:buildSettings:VALID_ARCHS arm64" iOS18SiriRipple.xcodeproj/project.pbxproj
        fi
        
        # ç¡®ä¿SDKè®¾ç½®ä¸ºiphoneos
        if ! grep -q "SDKROOT = iphoneos" iOS18SiriRipple.xcodeproj/project.pbxproj; then
          echo "è®¾ç½®SDKä¸ºiphoneos..."
          /usr/libexec/PlistBuddy -c "Set :objects:8F6D2D352A3F4A9C001A7C1F:buildSettings:SDKROOT iphoneos" iOS18SiriRipple.xcodeproj/project.pbxproj
        fi
        
        echo "âœ… é¡¹ç›®é…ç½®ä¿®å¤å®Œæˆ"
      
    # 6. ç¼–è¯‘é¡¹ç›®ï¼ˆä½¿ç”¨å…¨æ–°æ–¹æ³•ï¼‰
    - name: Build project
      run: |
        # æ¸…ç†ç¼“å­˜
        ./clean_cache.sh
        
        cd iOS18SiriRipple
        
        # ç¼–è¯‘å‘½ä»¤
        xcodebuild clean build \
          -project iOS18SiriRipple.xcodeproj \
          -scheme iOS18SiriRipple \
          -configuration Release \
          -sdk iphoneos \
          ARCHS=arm64 \
          VALID_ARCHS=arm64 \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          -derivedDataPath ../build_output \
          | tee xcodebuild.log
        
        # éªŒè¯ç¼–è¯‘äº§ç‰©
        BINARY_PATH="../build_output/Build/Products/Release-iphoneos/iOS18SiriRipple.framework/iOS18SiriRipple"
        if [ ! -f "$BINARY_PATH" ]; then
          echo "::error::âŒ ç¼–è¯‘äº§ç‰©ä¸å­˜åœ¨"
          echo "æž„å»ºæ—¥å¿—:"
          cat xcodebuild.log
          echo "æž„å»ºç›®å½•å†…å®¹:"
          ls -lR ../build_output
          exit 1
        else
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼äº§ç‰©è·¯å¾„: $BINARY_PATH"
          file "$BINARY_PATH"
        fi
        
        # ç­¾åäºŒè¿›åˆ¶æ–‡ä»¶
        ldid -S "$BINARY_PATH"
        echo "âœ… äºŒè¿›åˆ¶æ–‡ä»¶å·²ç­¾å"
      
    # 7. åˆ›å»ºDEBåŒ…
    - name: Create deb package
      run: |
        # åˆ›å»ºDEBåŒ…ç»“æž„
        mkdir -p package/Library/MobileSubstrate/DynamicLibraries
        mkdir -p package/DEBIAN
        
        # å¤åˆ¶ç¼–è¯‘äº§ç‰©
        cp build_output/Build/Products/Release-iphoneos/iOS18SiriRipple.framework/iOS18SiriRipple package/Library/MobileSubstrate/DynamicLibraries/iOS18SiriRipple.dylib
        
        # åˆ›å»ºplisté…ç½®æ–‡ä»¶
        cat > package/Library/MobileSubstrate/DynamicLibraries/iOS18SiriRipple.plist <<EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>Filter</key>
            <dict>
                <key>Bundles</key>
                <array>
                    <string>com.apple.springboard</string>
                </array>
            </dict>
        </dict>
        </plist>
        EOF
        
        # åˆ›å»ºcontrolæŽ§åˆ¶æ–‡ä»¶
        cat > package/DEBIAN/control <<EOF
        Package: com.behuge.ios18siriripple
        Name: iOS18SiriRipple
        Version: 1.0.0
        Architecture: iphoneos-arm
        Description: iOS 18 style Siri ripple animation
        Maintainer: 873116202
        Author: 873116202
        Section: Tweaks
        Depends: mobilesubstrate
        EOF
        
        # åˆ›å»ºå®‰è£…åŽè„šæœ¬
        cat > package/DEBIAN/postinst <<EOF
        #!/bin/bash
        # è®¾ç½®æ–‡ä»¶æƒé™
        /bin/chmod 0755 /Library/MobileSubstrate/DynamicLibraries/iOS18SiriRipple.dylib
        /bin/chmod 0644 /Library/MobileSubstrate/DynamicLibraries/iOS18SiriRipple.plist
        
        # é‡å¯SpringBoard
        /usr/bin/killall -9 SpringBoard
        exit 0
        EOF
        chmod 0755 package/DEBIAN/postinst
        
        # æ‰“åŒ…ä¸ºDEBæ–‡ä»¶
        dpkg-deb -Zgzip -b package ../iOS18SiriRipple.deb
        echo "ðŸŽ‰ DEBåŒ…åˆ›å»ºæˆåŠŸ: $(pwd)/../iOS18SiriRipple.deb"
      
    # 8. ä¸Šä¼ åˆ¶å“
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          iOS18SiriRipple.deb
          xcodebuild.log
      
    # 9. é”™è¯¯å¤„ç†
    - name: Upload error logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: error-logs
        path: |
          xcodebuild.log
          build_output/**/*
