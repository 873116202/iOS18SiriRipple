name: Build iOS18SiriRipple.deb

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-deb:
    runs-on: macos-latest
    timeout-minutes: 20
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    # 修复1：显示完整环境信息
    - name: Show environment
      run: |
        echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
        echo "Current directory: $(pwd)"
        ls -la
        echo "Xcode version: $(xcodebuild -version)"
        echo "SDK list:"
        xcodebuild -showsdks
        
    # 修复2：显式指定真机架构
    - name: Build project
      run: |
        # 进入项目目录
        cd iOS18SiriRipple
        
        # 清理历史构建
        rm -rf build ../build_output
        
        # 关键修复：添加ARCHS参数指定真机架构
        xcodebuild -project iOS18SiriRipple.xcodeproj \
                   -scheme iOS18SiriRipple \
                   -configuration Release \
                   -sdk iphoneos \
                   ARCHS=arm64 \
                   VALID_ARCHS=arm64 \
                   -derivedDataPath ../build_output \
                   CODE_SIGN_IDENTITY="" \
                   CODE_SIGNING_REQUIRED=NO \
                   CODE_SIGNING_ALLOWED=NO
        
        # 验证编译产物
        BINARY_PATH="../build_output/Build/Products/Release-iphoneos/iOS18SiriRipple.framework/iOS18SiriRipple"
        if [ ! -f "$BINARY_PATH" ]; then
          echo "❌ 错误：编译产物不存在"
          echo "构建目录内容："
          ls -lR ../build_output
          exit 1
        else
          echo "✅ 编译成功！产物路径：$BINARY_PATH"
        fi
        
    # 修复3：确保Metal文件被包含
    - name: Fix Metal shader inclusion
      run: |
        # 添加Metal文件到编译目标
        cd iOS18SiriRipple
        if ! grep -q "Shader.metal" iOS18SiriRipple.xcodeproj/project.pbxproj; then
          echo "添加Metal文件到项目..."
          /usr/libexec/PlistBuddy -c "Add :objects:8F6D2D352A3F4A9C001A7C1F:files:0 string Shader.metal" iOS18SiriRipple.xcodeproj/project.pbxproj
        fi
        
    # 后续打包步骤保持不变...
    - name: Create deb package
      run: |
        # ... (保持原有打包逻辑)
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: iOS18SiriRipple.deb
        path: iOS18SiriRipple.deb
