name: Build iOS18SiriRipple.deb

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-deb:
    runs-on: macos-latest
    timeout-minutes: 30
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout code
      uses: actions/checkout@v4
      
    # 2. çŽ¯å¢ƒè¯Šæ–­
    - name: Diagnostic information
      run: |
        echo "##[group]ðŸ› ï¸ çŽ¯å¢ƒè¯Šæ–­"
        echo "å·¥ä½œç›®å½•: $(pwd)"
        echo "Xcodeç‰ˆæœ¬: $(xcodebuild -version)"
        echo "å¯ç”¨SDK:"
        xcodebuild -showsdks
        echo "é¡¹ç›®ç»“æž„:"
        ls -la
        echo "##[endgroup]"
      
    # 3. å®‰è£…å¿…è¦å·¥å…·
    - name: Install build tools
      run: |
        brew update
        # å®‰è£…å¿…è¦å·¥å…·
        brew install dpkg ldid
      
    # 4. è®¾ç½®å¼€å‘çŽ¯å¢ƒ
    - name: Setup environment
      run: |
        # è®¾ç½®Xcodeè·¯å¾„
        sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
        
        # åˆ›å»ºç¼“å­˜æ¸…ç†è„šæœ¬
        cat > clean_cache.sh <<EOF
        #!/bin/bash
        echo "æ¸…ç†æž„å»ºç¼“å­˜..."
        rm -rf build_output
        rm -rf ~/Library/Developer/Xcode/DerivedData/*
        rm -rf ~/Library/Caches/com.apple.dt.Xcode/*
        echo "âœ… ç¼“å­˜æ¸…ç†å®Œæˆ"
        EOF
        chmod +x clean_cache.sh
        
        # ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
        mkdir -p logs
      
    # 5. ç¼–è¯‘é¡¹ç›®ï¼ˆä½¿ç”¨å‚æ•°è¦†ç›–è®¾ç½®ï¼‰
    - name: Build project
      run: |
        # æ¸…ç†ç¼“å­˜
        ./clean_cache.sh
        
        cd iOS18SiriRipple
        
        # ç¼–è¯‘å‘½ä»¤ - ä½¿ç”¨å‚æ•°è¦†ç›–è®¾ç½®
        set -x  # å¼€å¯è¯¦ç»†æ—¥å¿—
        xcodebuild clean build \
          -project iOS18SiriRipple.xcodeproj \
          -scheme iOS18SiriRipple \
          -configuration Release \
          -sdk iphoneos \
          ARCHS=arm64 \
          VALID_ARCHS=arm64 \
          SDKROOT=iphoneos \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          -derivedDataPath ../build_output \
          | tee ../xcodebuild.log
        set +x  # å…³é—­è¯¦ç»†æ—¥å¿—
        
        # éªŒè¯ç¼–è¯‘äº§ç‰©
        BINARY_PATH="../build_output/Build/Products/Release-iphoneos/iOS18SiriRipple.framework/iOS18SiriRipple"
        if [ ! -f "$BINARY_PATH" ]; then
          echo "::error::âŒ ç¼–è¯‘äº§ç‰©ä¸å­˜åœ¨"
          echo "æž„å»ºæ—¥å¿—:"
          cat
