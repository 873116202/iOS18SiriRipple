name: Build iOS18SiriRipple.deb

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-deb:
    runs-on: macos-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      run: |
        sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
        echo "Xcodeç‰ˆæœ¬: $(xcodebuild -version)"
        echo "å·¥ä½œç›®å½•: $(pwd)"
        echo "æ–‡ä»¶å¤¹å†…å®¹:"
        ls -la
      
    - name: Verify project exists
      id: check_project
      run: |
        if [ ! -d "iOS18SiriRipple.xcodeproj" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° iOS18SiriRipple.xcodeproj"
          exit 1
        else
          echo "âœ… æ‰¾åˆ°é¡¹ç›®æ–‡ä»¶"
        fi
        
    - name: Build project
      run: |
        # æ·»åŠ è¯¦ç»†æ—¥å¿—
        set -x  # å¯ç”¨è¯¦ç»†å‘½ä»¤å›æ˜¾
        
        # æ¸…ç†å†å²ç¼–è¯‘æ–‡ä»¶
        rm -rf build
        
        # ä½¿ç”¨ç»å¯¹è·¯å¾„ç¡®ä¿ä½ç½®æ­£ç¡®
        xcodebuild -project iOS18SiriRipple.xcodeproj \
                   -scheme iOS18SiriRipple \
                   -configuration Release \
                   -sdk iphoneos \
                   -derivedDataPath $PWD/build \
                   CODE_SIGN_IDENTITY="" \
                   CODE_SIGNING_REQUIRED=NO \
                   CODE_SIGNING_ALLOWED=NO \
                   | tee xcodebuild.log  # ä¿å­˜è¯¦ç»†æ—¥å¿—
        
        # éªŒè¯ç¼–è¯‘äº§ç‰©å­˜åœ¨
        if [ ! -d "build/Build/Products/Release-iphoneos" ]; then
          echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œæœªç”Ÿæˆäº§ç‰©ç›®å½•"
          echo "=== Xcodeç¼–è¯‘æ—¥å¿— ==="
          cat xcodebuild.log
          exit 1
        fi
        
    - name: Create deb package
      run: |
        # è®¾ç½®ä¸¥æ ¼é”™è¯¯æ£€æŸ¥
        set -euo pipefail
        
        # æ˜¾å¼å®šä¹‰ç¼–è¯‘äº§ç‰©è·¯å¾„
        BUILD_PATH="build/Build/Products/Release-iphoneos"
        BINARY="$BUILD_PATH/iOS18SiriRipple.framework/iOS18SiriRipple"
        
        echo "ğŸ“¦ ç¼–è¯‘äº§ç‰©è·¯å¾„: $BINARY"
        
        # éªŒè¯æ–‡ä»¶å­˜åœ¨
        if [ ! -f "$BINARY" ]; then
          echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°ç¼–è¯‘äº§ç‰©ï¼š$BINARY"
          echo "ç›®å½•å†…å®¹ï¼š"
          ls -lR "$BUILD_PATH"
          exit 1
        fi
        
        # åˆ›å»ºåŒ…ç»“æ„
        mkdir -p package/Library/MobileSubstrate/DynamicLibraries
        mkdir -p package/DEBIAN
        
        # å¤åˆ¶æ–‡ä»¶ï¼ˆä½¿ç”¨ç»å¯¹è·¯å¾„ï¼‰
        cp "$BINARY" package/Library/MobileSubstrate/DynamicLibraries/iOS18SiriRipple.dylib
        echo "âœ… å·²å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶"
        
        # åç»­æ‰“åŒ…ä»£ç ä¿æŒä¸å˜...
        # [ä¿æŒåŸæ‰“åŒ…é€»è¾‘ï¼Œä½†æ­¤å¤„çœç•¥é‡å¤ä»£ç ]
        
        # æ·»åŠ æˆåŠŸæ ‡è®°
        echo "ğŸ‰ DEB åŒ…åˆ›å»ºæˆåŠŸï¼"
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: iOS18SiriRipple.deb
        path: iOS18SiriRipple.deb
      
    # åç»­æ­¥éª¤ä¿æŒä¸å˜...

        
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          *.deb
          build/*.dylib
        tag_name: ${{ github.ref }}
        body: "iOS18SiriRipple deb package"
