name: Build iOS18SiriRipple.deb

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-deb:
    runs-on: macos-latest
    timeout-minutes: 15
    
    steps:
    # 1. æ£€å‡ºä»£ç åˆ°æ ¹ç›®å½•
    - name: Checkout code
      uses: actions/checkout@v4
      
    # 2. ç¡®è®¤æ ¹ç›®å½•ä¸‹çš„é¡¹ç›®ç»“æž„
    - name: Verify root directory structure
      run: |
        echo "ðŸ“‚ æ ¹ç›®å½•å†…å®¹:"
        ls -la
        echo ""
        
        if [ ! -d "iOS18SiriRipple.xcodeproj" ]; then
          echo "âŒ é”™è¯¯ï¼šåœ¨æ ¹ç›®å½•æœªæ‰¾åˆ° iOS18SiriRipple.xcodeproj"
          echo "è¯·ç¡®ä¿é¡¹ç›®æ–‡ä»¶ä½äºŽä»“åº“æ ¹ç›®å½•"
          exit 1
        else
          echo "âœ… åœ¨æ ¹ç›®å½•æ‰¾åˆ° iOS18SiriRipple.xcodeproj"
        fi
        
        if [ ! -d "iOS18SiriRipple" ]; then
          echo "âš ï¸ æ³¨æ„ï¼šæœªæ‰¾åˆ° iOS18SiriRipple æºç ç›®å½•"
        else
          echo "âœ… åœ¨æ ¹ç›®å½•æ‰¾åˆ° iOS18SiriRipple æºç ç›®å½•"
        fi
      
    # 3. è®¾ç½®å¼€å‘çŽ¯å¢ƒ  
    - name: Setup Xcode environment
      run: |
        sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
        xcodebuild -version
        echo "å·¥ä½œç›®å½•: $(pwd)"
      
    # 4. å®‰è£…å¿…è¦å·¥å…·
    - name: Install build tools
      run: |
        brew update
        brew install dpkg
        brew install ldid
      
    # 5. ç¼–è¯‘é¡¹ç›®
    - name: Build project (from root)
      run: |
        # ç¡®ä¿åœ¨æ ¹ç›®å½•å·¥ä½œ
        echo "ðŸ› ï¸ å¼€å§‹æž„å»ºé¡¹ç›®..."
        xcodebuild -project iOS18SiriRipple.xcodeproj \
                   -scheme iOS18SiriRipple \
                   -configuration Release \
                   -sdk iphoneos \
                   -derivedDataPath build_output \
                   CODE_SIGN_IDENTITY="" \
                   CODE_SIGNING_REQUIRED=NO \
                   CODE_SIGNING_ALLOWED=NO
        
        echo "âœ… é¡¹ç›®ç¼–è¯‘å®Œæˆ"
      
    # 6. åˆ›å»ºDEBåŒ…
    - name: Create deb package
      run: |
        # è®¾ç½®ç¼–è¯‘äº§ç‰©è·¯å¾„
        BINARY_PATH="build_output/Build/Products/Release-iphoneos/iOS18SiriRipple.framework/iOS18SiriRipple"
        
        # éªŒè¯ç¼–è¯‘äº§ç‰©å­˜åœ¨
        if [ ! -f "$BINARY_PATH" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°ç¼–è¯‘äº§ç‰©: $BINARY_PATH"
          echo "ç¼–è¯‘è¾“å‡ºç›®å½•å†…å®¹:"
          ls -lR build_output
          exit 1
        fi
        
        # åˆ›å»ºDEBåŒ…ç»“æž„
        mkdir -p package/Library/MobileSubstrate/DynamicLibraries
        mkdir -p package/DEBIAN
        
        # å¤åˆ¶ç¼–è¯‘äº§ç‰©
        cp "$BINARY_PATH" package/Library/MobileSubstrate/DynamicLibraries/iOS18SiriRipple.dylib
        echo "âœ… å·²å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶"
        
        # åˆ›å»ºplisté…ç½®æ–‡ä»¶
        cat > package/Library/MobileSubstrate/DynamicLibraries/iOS18SiriRipple.plist <<EOF
        { 
            Filter = { 
                Bundles = ( "com.apple.springboard" ); 
            }; 
        }
        EOF
        echo "âœ… å·²åˆ›å»ºplistæ–‡ä»¶"
        
        # åˆ›å»ºcontrolæŽ§åˆ¶æ–‡ä»¶
        cat > package/DEBIAN/control <<EOF
        Package: com.behuge.ios18siriripple
        Name: iOS18SiriRipple
        Version: 1.0.0
        Architecture: iphoneos-arm
        Description: iOS 18 style Siri ripple animation
        Maintainer: 873116202
        Author: 873116202
        Section: Tweaks
        Depends: mobilesubstrate
        EOF
        echo "âœ… å·²åˆ›å»ºcontrolæ–‡ä»¶"
        
        # åˆ›å»ºå®‰è£…åŽè„šæœ¬
        cat > package/DEBIAN/postinst <<EOF
        #!/bin/sh
        # è®¾ç½®æ–‡ä»¶æƒé™
        chmod 0755 /Library/MobileSubstrate/DynamicLibraries/iOS18SiriRipple.dylib
        chmod 0644 /Library/MobileSubstrate/DynamicLibraries/iOS18SiriRipple.plist
        
        # æç¤ºé‡å¯SpringBoardè€Œéžæ•´ä¸ªç³»ç»Ÿ
        launchctl stop com.apple.SpringBoard
        launchctl start com.apple.SpringBoard
        
        echo "âœ… iOS18SiriRippleå·²æˆåŠŸå®‰è£…ï¼è¯·è§£é”è®¾å¤‡æŸ¥çœ‹æ•ˆæžœ"
        EOF
        chmod 0755 package/DEBIAN/postinst
        echo "âœ… å·²åˆ›å»ºpostinstè„šæœ¬"
        
        # æ‰“åŒ…ä¸ºDEBæ–‡ä»¶
        dpkg-deb -b package iOS18SiriRipple.deb
        echo "ðŸŽ‰ DEBåŒ…åˆ›å»ºæˆåŠŸï¼šiOS18SiriRipple.deb"
      
    # 7. ä¸Šä¼ åˆ¶å“
    - name: Upload DEB artifact
      uses: actions/upload-artifact@v4
      with:
        name: iOS18SiriRipple.deb
        path: iOS18SiriRipple.deb
      
    # 8. åˆ›å»ºå‘å¸ƒï¼ˆå¯é€‰ï¼‰
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: iOS18SiriRipple.deb
