name: Build iOS18SiriRipple.deb

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-deb:
    runs-on: macos-latest
    timeout-minutes: 20
    env:
      PROJECT_NAME: iOS18SiriRipple
    
    steps:
    # 1. 检出代码
    - name: Checkout code
      uses: actions/checkout@v4
      
    # 2. 确认项目结构
    - name: Verify project structure
      run: |
        echo "📂 项目结构:"
        ls -la
        echo ""
        echo "📦 ${{ env.PROJECT_NAME }} 目录内容:"
        ls -la ${{ env.PROJECT_NAME }}/
      
    # 3. 设置Xcode环境  
    - name: Setup Xcode
      run: |
        sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
        echo "Xcode版本: $(xcodebuild -version)"
        echo "工作目录: $(pwd)"
      
    # 4. 安装必要工具
    - name: Install build tools
      run: |
        brew update
        brew install dpkg
        brew install ldid
        brew install wget
      
    # 5. 编译项目（使用正确的项目路径）
    - name: Build project
      run: |
        # 进入项目目录
        cd ${{ env.PROJECT_NAME }}
        
        echo "🛠️ 开始构建项目..."
        xcodebuild -project ${{ env.PROJECT_NAME }}.xcodeproj \
                   -scheme ${{ env.PROJECT_NAME }} \
                   -configuration Release \
                   -sdk iphoneos \
                   -derivedDataPath ../build_output \
                   CODE_SIGN_IDENTITY="" \
                   CODE_SIGNING_REQUIRED=NO \
                   CODE_SIGNING_ALLOWED=NO
        
        echo "✅ 项目编译完成"
      
    # 6. 创建DEB包
    - name: Create deb package
      run: |
        # 设置编译产物路径
        BINARY_PATH="build_output/Build/Products/Release-iphoneos/${{ env.PROJECT_NAME }}.framework/${{ env.PROJECT_NAME }}"
        
        # 验证编译产物存在
        if [ ! -f "$BINARY_PATH" ]; then
          echo "❌ 错误：未找到编译产物"
          echo "编译输出目录内容:"
          ls -lR build_output
          exit 1
        fi
        
        # 创建DEB包结构
        mkdir -p package/Library/MobileSubstrate/DynamicLibraries
        mkdir -p package/DEBIAN
        
        # 复制编译产物
        cp "$BINARY_PATH" package/Library/MobileSubstrate/DynamicLibraries/${{ env.PROJECT_NAME }}.dylib
        echo "✅ 已复制二进制文件"
        
        # 创建plist配置文件
        cat > package/Library/MobileSubstrate/DynamicLibraries/${{ env.PROJECT_NAME }}.plist <<EOF
        { 
            Filter = { 
                Bundles = ( "com.apple.springboard" ); 
            }; 
        }
        EOF
        echo "✅ 已创建plist文件"
        
        # 创建control控制文件
        cat > package/DEBIAN/control <<EOF
        Package: com.behuge.${{ env.PROJECT_NAME }}
        Name: ${{ env.PROJECT_NAME }}
        Version: 1.0.0
        Architecture: iphoneos-arm
        Description: iOS 18 style Siri ripple animation
        Maintainer: 873116202
        Author: 873116202
        Section: Tweaks
        Depends: mobilesubstrate
        EOF
        echo "✅ 已创建control文件"
        
        # 创建安装后脚本
        cat > package/DEBIAN/postinst <<EOF
        #!/bin/bash
        # 设置文件权限
        chmod 0755 /Library/MobileSubstrate/DynamicLibraries/${{ env.PROJECT_NAME }}.dylib
        chmod 0644 /Library/MobileSubstrate/DynamicLibraries/${{ env.PROJECT_NAME }}.plist
        
        # 重启SpringBoard
        killall -9 SpringBoard
        echo "✅ SpringBoard已重启，请解锁设备查看效果"
        EOF
        chmod 0755 package/DEBIAN/postinst
        echo "✅ 已创建postinst脚本"
        
        # 打包为DEB文件
        dpkg-deb -b package ../${{ env.PROJECT_NAME }}.deb
        echo "🎉 DEB包创建成功：${{ env.PROJECT_NAME }}.deb"
      
    # 7. 上传制品
    - name: Upload DEB artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}.deb
        path: ${{ env.PROJECT_NAME }}.deb
      
    # 8. 创建发布（可选）
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ env.PROJECT_NAME }}.deb
        tag_name: ${{ github.ref }}
        body: "iOS18SiriRipple deb package"
