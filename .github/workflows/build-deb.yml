name: Build iOS18SiriRipple.deb

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-deb:
    runs-on: macos-latest
    timeout-minutes: 20
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    # å¢å¼ºçš„ç¼–è¯‘å‰æ£€æŸ¥
    - name: Pre-build validation
      run: |
        echo "ğŸ” é¡¹ç›®ç»“æ„éªŒè¯ï¼š"
        ls -la
        
        if [ ! -f "iOS18SiriRipple/iOS18SiriRipple.xcodeproj/project.pbxproj" ]; then
          echo "âŒ è‡´å‘½é”™è¯¯ï¼šé¡¹ç›®æ–‡ä»¶ç¼ºå¤±ï¼"
          exit 1
        fi
        
        echo "âœ… é¡¹ç›®éªŒè¯é€šè¿‡"
      
    - name: Setup Xcode
      run: |
        sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
        echo "Xcodeç‰ˆæœ¬: $(xcodebuild -version)"
      
    - name: Install dependencies
      run: |
        brew update
        brew install dpkg ldid
      
    # å…³é”®ä¿®å¤ï¼šç¼–è¯‘æ­¥éª¤å¢å¼º
    - name: Build project
      id: compile
      run: |
        cd iOS18SiriRipple
        
        # å¯ç”¨è¯¦ç»†æ—¥å¿—
        set -x
        
        # æ¸…ç†å†å²æ„å»º
        rm -rf build ../build_output
        
        # æ‰§è¡Œç¼–è¯‘ï¼ˆè®°å½•æ—¥å¿—ï¼‰
        xcodebuild -project iOS18SiriRipple.xcodeproj \
                   -scheme iOS18SiriRipple \
                   -configuration Release \
                   -sdk iphoneos \
                   -derivedDataPath ../build_output \
                   CODE_SIGN_IDENTITY="" \
                   CODE_SIGNING_REQUIRED=NO \
                   CODE_SIGNING_ALLOWED=NO \
                   > ../xcodebuild.log 2>&1 || {
                       echo "âŒ ç¼–è¯‘å¤±è´¥ï¼å®Œæ•´æ—¥å¿—ï¼š"
                       cat ../xcodebuild.log
                       exit 1
                   }
        
        # éªŒè¯ç¼–è¯‘äº§ç‰©
        if [ -f "../build_output/Build/Products/Release-iphoneos/iOS18SiriRipple.framework/iOS18SiriRipple" ]; then
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼äº§ç‰©ä½ç½®ï¼š"
          ls -lR ../build_output/Build/Products
        else
          echo "âŒ é”™è¯¯ï¼šæœªç”Ÿæˆç¼–è¯‘äº§ç‰©"
          echo "ç¼–è¯‘æ—¥å¿—ï¼š"
          cat ../xcodebuild.log
          exit 1
        fi
      
    # å®‰å…¨çš„è¯Šæ–­æ­¥éª¤
    - name: Post-build diagnostics
      if: steps.compile.outcome == 'success'
      run: |
        echo "ğŸ“Š æ„å»ºåè¯Šæ–­ï¼š"
        echo "1. ç¼–è¯‘è¾“å‡ºç›®å½•ï¼š"
        ls -lR build_output
        
        echo "2. æŸ¥æ‰¾æ„å»ºäº§ç‰©ï¼š"
        find build_output -name "iOS18SiriRipple" -print
        
        echo "âœ… è¯Šæ–­å®Œæˆ"
      
    - name: Create deb package
      if: steps.compile.outcome == 'success'
      run: |
        # [ä¿æŒåŸæœ‰çš„æ‰“åŒ…é€»è¾‘]
        echo "ğŸ“¦ å¼€å§‹æ‰“åŒ…..."
      
    - name: Upload artifacts
      if: steps.compile.outcome == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          iOS18SiriRipple.deb
          xcodebuild.log
          build_output/
      
    # æ•…éšœæƒ…å†µä¸‹ä¸Šä¼ æ—¥å¿—
    - name: Upload error logs
      if: steps.compile.outcome != 'success'
      uses: actions/upload-artifact@v4
      with:
        name: error-logs
        path: xcodebuild.log
