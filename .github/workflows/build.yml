name: Build iOS18SiriRipple Deb
on: [push]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      # 安装必要依赖
      - name: Install dependencies
        run: |
          brew install ldid xz dpkg git
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      # 设置Theos环境 - 修复版本
      - name: Setup Theos environment
        run: |
          export THEOS=~/theos  # 改为主目录避免权限问题
          
          # 删除旧安装(无sudo)
          rm -rf $THEOS >/dev/null 2>&1 || true
          
          # 克隆Theos(无sudo)
          git clone --depth=1 https://github.com/theos/theos.git $THEOS
          
          # 修复关键路径(无sudo)
          $THEOS/bin/update-theos
          
          # 安装iOS SDK (解决常见编译错误)
          mkdir -p $THEOS/sdks
          curl -LO https://github.com/theos/sdks/archive/master.zip
          unzip master.zip -d $THEOS/sdks/
          mv $THEOS/sdks/sdks-master/iPhoneOS*.sdk $THEOS/sdks/
          
          # 永久设置环境变量
          echo "THEOS=$THEOS" >> $GITHUB_ENV
          echo "PATH=$THEOS/bin:$PATH" >> $GITHUB_ENV
          echo "THEOS_SDK_DIR=$THEOS/sdks" >> $GITHUB_ENV

      # 编译和打包
      - name: Build and package
        run: |
          # 进入项目目录
          cd iOS18SiriRipple
          
          # 清理并构建包
          make clean
          make package