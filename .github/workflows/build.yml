name: Build iOS18SiriRipple Deb

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Theos environment
        run: |
          export THEOS=/opt/theos
          sudo rm -rf $THEOS >/dev/null 2>&1 || true
          sudo git clone --depth=1 https://github.com/theos/theos.git $THEOS
          
          # 关键修复1: 使用正确的初始化命令
          sudo $THEOS/bin/update-theos
          
          # 导出环境变量
          echo "THEOS=$THEOS" >> $GITHUB_ENV
          echo "THEOS_MAKE_PATH=/opt/theos/makefiles" >> $GITHUB_ENV
      
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git clang curl libc++-dev libc++abi-dev libperl-dev xz-utils
          
          # 关键修复2: 解决ld链接问题
          sudo ln -sf /usr/bin/ld.lld /usr/bin/ld || true
      
      - name: Prepare build structure
        run: |
          # 创建必需的目录
          mkdir -p Tweak
          
          # 处理源文件
          if [ -f "iOS18SiriRipple.xm" ]; then
            mv iOS18SiriRipple.xm Tweak/Tweak.xm
          else
            mv *.m Tweak/Tweak.xm
          fi
          
          # 关键修复3: 确保使用正确的Makefile
          [ -f .github/templates/Makefile ] && cp .github/templates/Makefile Tweak/Makefile
          [ -f .github/templates/control ] && cp .github/templates/control Tweak/control
          [ -d Resources ] && mv Resources Tweak/Resources
          
          echo "项目结构:"
          tree -L 2
      
      - name: Build ARM64 package
        # 关键修复4: 切换到Tweak目录构建
        working-directory: ./Tweak
        run: |
          echo "当前目录: $(pwd)"
          echo "文件列表:"
          ls -la
          
          make clean
          make package ARCHS=arm64
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: iOS18SiriRipple_Deb_Package
          path: Tweak/packages/*.deb