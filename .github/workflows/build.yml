name: Build iOS18SiriRipple.deb

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-deb:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Xcode
      run: |
        sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
        xcodebuild -version
        
    - name: Install dependencies
      run: |
        brew update
        brew install dpkg
        brew install ldid
        
    - name: Build project
      run: |
        cd ${GITHUB_WORKSPACE}
        xcodebuild -scheme iOS18SiriRipple -configuration Release -sdk iphoneos \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
        
    - name: Create deb package
      run: |
        # 创建包结构
        mkdir -p package/Library/MobileSubstrate/DynamicLibraries
        mkdir -p package/DEBIAN
        
        # 复制编译产物
        cp build/Release-iphoneos/iOS18SiriRipple.framework/iOS18SiriRipple package/Library/MobileSubstrate/DynamicLibraries/iOS18SiriRipple.dylib
        
        # 创建plist文件
        cat > package/Library/MobileSubstrate/DynamicLibraries/iOS18SiriRipple.plist <<EOF
        { Filter = { Bundles = ( "com.apple.springboard" ); }; }
        EOF
        
        # 创建control文件
        cat > package/DEBIAN/control <<EOF
        Package: com.behuge.ios18siriripple
        Name: iOS18SiriRipple
        Version: 0.0.1
        Architecture: iphoneos-arm
        Description: iOS 18 style Siri ripple animation
        Maintainer: 873116202
        Author: 873116202
        Section: Tweaks
        Depends: mobilesubstrate
        EOF
        
        # 创建postinst脚本
        cat > package/DEBIAN/postinst <<EOF
        #!/bin/sh
        chmod 0755 /Library/MobileSubstrate/DynamicLibraries/iOS18SiriRipple.dylib
        chmod 0644 /Library/MobileSubstrate/DynamicLibraries/iOS18SiriRipple.plist
        /sbin/reboot
        EOF
        chmod 0755 package/DEBIAN/postinst
        
        # 构建deb包
        dpkg-deb -b package iOS18SiriRipple.deb
        
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: iOS18SiriRipple.deb
        path: iOS18SiriRipple.deb
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: iOS18SiriRipple.deb
